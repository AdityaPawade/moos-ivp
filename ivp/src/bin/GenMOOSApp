#!/bin/bash
#Modified by ajshafer on Aug 15

if [ -z "$1" ] ; then
    echo "GenMOOSApp: usage: $0 [app-name] [prefix]"
    exit 0
fi

if [ -z "$2" ] ; then
    echo "GenMOOSApp: usage: $0 [app-name] [prefix]"
    exit 0
fi

mkdir $2$1
cd $2$1

cat >> makefile <<EOF
# Makefile for $1

LTARGET  = $2$1
LIFLAGS  =
LCFLAGS  =

PLIBS    = libMOOS.a libMOOSGen.a libmbutil.a
LIBS     = -lm -lpthread \$(patsubst lib%.a,-l%,\$(PLIBS))
PLDIRS   = \$(wildcard ../lib_*) ../MOOSLIB ../MOOSGenLib

# Make configuration parameters
include ../make_config.mk
# Generic makefile structure for all application modules
include ../make_app.mk
# DO NOT DELETE

EOF

cat >> ${1}.h <<EOF
/************************************************************/
/*    NAME: Andrew Shafer                                   */
/*    ORGN: MIT                                             */
/*    FILE: ${1}.h                                          */
/*    DATE: Aug 15 2007                                     */
/************************************************************/

#ifndef ${1}_HEADER
#define ${1}_HEADER

#include "MOOSLib.h"

class ${1} : public CMOOSApp
{
public:
	${1}();
	virtual ~${1}();

	bool OnNewMail(MOOSMSG_LIST &NewMail);
	bool Iterate();
	bool OnConnectToServer();
	bool OnStartUp();

protected:
	// insert local vars here
};

#endif 
EOF

cat >> ${1}Main.cpp <<EOF
/************************************************************/
/*    NAME: Andrew Shafer                                   */
/*    ORGN: MIT                                             */
/*    FILE: ${1}Main.cpp                                    */
/*    DATE: Aug 15 2007                                     */
/************************************************************/

#include "MOOSLib.h"
#include "MOOSGenLib.h"
#include "${1}.h"

int main(int argc, char *argv[])
{
  char *sMissionFile = "${1}.moos";
	
  if(argc > 1)
    sMissionFile = argv[1];
	
  ${1} ${1};
	
  ${1}.Run("${2}${1}", sMissionFile);

  return(0);
}

EOF

cat >> $2${1}.moos <<EOF
// MOOS file

ServerHost = localhost
ServerPort = 9000

ProcessConfig = ${2}${1}
{
   AppTick   = 4
   CommsTick = 4
}

EOF

cat >> ${1}.cpp <<EOF
/************************************************************/
/*    NAME: Andrew Shafer                                   */
/*    ORGN: MIT                                             */
/*    FILE: ${1}.cpp                                        */
/*    DATE: Aug 15 2007                                     */
/************************************************************/

#include <iterator>
#include "${1}.h"
//---------------------------------------------------------
// Constructor

${1}::${1}()
{
}

//---------------------------------------------------------
// Destructor

${1}::~${1}()
{
}

//---------------------------------------------------------
// Procedure: OnNewMail

bool ${1}::OnNewMail(MOOSMSG_LIST &NewMail)
{
	MOOSMSG_LIST::reverse_iterator p;
	
	for(p = NewMail.rbegin(); p != NewMail.rend(); p++) {
		CMOOSMsg &msg = *p;
	}
	
	return true;
}

//---------------------------------------------------------
// Procedure: OnConnectToServer

bool ${1}::OnConnectToServer()
{
	// register for variables here
	// possibly look at the mission file?
	// m_MissionReader.GetConfigurationParam("Name", <string>);
	// m_Comms.Register("VARNAME", is_float(int));
	
	return true;
}

//---------------------------------------------------------
// Procedure: Iterate()

bool ${1}::Iterate()
{
	// happens AppTick times per second
	
	return true;
}

//---------------------------------------------------------
// Procedure: OnStartUp()

bool ${1}::OnStartUp()
{
	// happens before connection is open
	
	return true;
}

EOF

echo "$2${1} generated"
